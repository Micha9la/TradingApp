@page "/trades"

@using TradingApp.BlazorUI.Services
@inject ITradeService TradeService
@inject CsvTradeImporter Importer
@inject IWebHostEnvironment Env
@inject ITradeService GoogleSheetService
@using TradingApp
@using TradingApp.BlazorUI.Data
@using MudBlazor


<h3>Imported Trades</h3>
<div class="d-flex flex-column align-items-center gap-3 mt-4">
    <NavLink class="btn btn-primary" href="/landingpage">Enter Trade</NavLink>
</div>

@if (trades == null)
{
    <p>Loading...</p>
}
else if (!trades.Any())
{
    <p>No trades found.</p>
    <p>Total Trades: @trades?.Count</p>

}
else
{
    <MudDataGrid T="TradeEntry"
                 Items="@trades"
                 Filterable="true"
                 Groupable="false"
                 SortMode="SortMode.Multiple"
                 EditMode="DataGridEditMode.Cell"
                 @ref="gridRef">

        <!-- Top toolbar -->
        <ToolBarContent>
            <MudText Typo="Typo.h6">Trades</MudText>
            <MudSpacer />

            <!-- Global Quick Filter -->
            <MudTextField @bind-Value="_search"
                          Placeholder="Search all columns"
                          Adornment="Adornment.Start"
                          Immediate="true"
                          AdornmentIcon="@Icons.Material.Filled.Search" />
        </ToolBarContent>

        <Columns>

            <SelectColumn T="TradeEntry" />

            <PropertyColumn Property="x => x.CatalogNumber" Title="Catalog No" />
            <PropertyColumn Property="x => x.Date" Title="Date" Format="d" />

            <PropertyColumn Property="x => x.TradeDirection" Title="Direction" />

            <PropertyColumn Property="x => x.Company.CompanyName"
                            Title="Company"
                            Filterable="true" />

            <PropertyColumn Property="x => x.Company.ContactPerson"
                            Title="Contact Person"
                            Filterable="true" />

            <PropertyColumn Property="x => x.Product.ProductName"
                            Title="Product"
                            Filterable="true" />

            <PropertyColumn Property="x => x.Product.Quantity"
                            Title="Quantity" />

            <PropertyColumn Property="x => x.Price" Title="Price" />
            <PropertyColumn Property="x => x.Currency" Title="Currency" />

            <PropertyColumn Property="x => x.Records" Title="Records" />
            <PropertyColumn Property="x => x.PrivateNotes" Title="Private Notes" Editable="true" />

            

        </Columns>
        <PagerContent>
            <MudDataGridPager T="TradeEntry" />
        </PagerContent>
    
</MudDataGrid>

    @if (_events.Any())
    {
        <MudExpansionPanels>
            <MudExpansionPanel Text="Events">
                @foreach (var ev in _events)
                {
                    <MudText Typo="Typo.body2">@ev</MudText>
                }
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
}

<p>Total Trades: @trades?.Count</p>

<button @onclick="TestGoogleSheetRead">Test Read</button>

@code {
    private List<TradeEntry> trades = new();
    private MudDataGrid<TradeEntry>? gridRef;
    private string _search = "";
    private List<string> _events = new();

    protected override async Task OnInitializedAsync()
    {
        trades = await GoogleSheetService.GetAllTradesAsync();
        Console.WriteLine($"Loaded {trades.Count} trades from Google Sheets"); //logging
    }


    private void ShareViaWhatsApp(TradeEntry entry)
    {
        
    }

    private async Task TestGoogleSheetRead()
    {
        trades = await GoogleSheetService.GetAllTradesAsync();

        Console.WriteLine($"TestRead: Found {trades?.Count ?? 0} trades");
        await InvokeAsync(StateHasChanged);
    }
}
}


