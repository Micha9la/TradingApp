@page "/trades"

@using TradingApp.BlazorUI.Services
@inject ITradeService TradeService
@inject CsvTradeImporter Importer
@inject IWebHostEnvironment Env
@inject ITradeService GoogleSheetService
@using TradingApp
@using TradingApp.BlazorUI.Data
@using MudBlazor


<h3>Imported Trades</h3>
<div class="d-flex flex-column align-items-center gap-3 mt-4">
    <NavLink class="btn btn-primary" href="/landingpage">Enter Trade</NavLink>
</div>

@if (trades == null)
{
    <p>Loading...</p>
}
else if (!trades.Any())
{
    <p>No trades found.</p>
    <p>Total Trades: @trades?.Count</p>

}
else
{
    <MudDataGrid T="TradeEntry"
                 MultiSelection="true"
                 Items="@trades"
                 Filterable="true"
                 QuickFilter="@QuickFilter"
                 Hideable="true" 
                 Groupable="false"
                 SortMode="SortMode.Multiple"
                 EditMode="DataGridEditMode.Cell"
                 CanEdit="true"
                 @ref="gridRef">

        <!-- Top toolbar -->
        <ToolBarContent>
            <MudText Typo="Typo.h6">Trades</MudText>
            <MudSpacer />

            <!-- Global Quick Filter -->
            <MudTextField @bind-Value="_search"
                          Placeholder="Search all columns"
                          Adornment="Adornment.Start"
                          Immediate="true"
                          AdornmentIcon="@Icons.Material.Filled.Search" />
        </ToolBarContent>

        <Columns>

            <SelectColumn T="TradeEntry" />

            <PropertyColumn Property="x => x.CatalogNumber" Title="Catalog No" />
            <PropertyColumn Property="x => x.Date" Title="Date" Format="d" />

            <PropertyColumn Property="x => x.TradeDirection" Title="Direction" />

            <PropertyColumn Property="x => x.Company.CompanyName"
                            Title="Company"
                            Filterable="true" />

            <PropertyColumn Property="x => x.Company.ContactPerson"
                            Title="Contact Person"
                            Filterable="true" />

            <PropertyColumn Property="x => x.Product.ProductName"
                            Title="Product"
                            Filterable="true" />

            <PropertyColumn Property="x => x.Product.Quantity"
                            Title="Quantity" />

            <PropertyColumn Property="x => x.Product.ProductQuality.Protein"
                            Title="Protein" />
            <PropertyColumn Property="x => x.Product.ProductQuality.TestWeight"
                            Title="TestWeight" />
            <PropertyColumn Property="x => x.Product.ProductQuality.FallingNumber"
                            Title="FallingNumber" />
            <PropertyColumn Property="x => x.Product.ProductQuality.Glassiness"
                            Title="Glassiness" />
            <PropertyColumn Property="x => x.Product.ProductQuality.OilContent"
                            Title="OilContent" />
            <PropertyColumn Property="x => x.Product.ProductQuality.DamagedKernels"
                            Title="DamagedKernels" />
            <PropertyColumn Property="x => x.Product.ProductQuality.Don"
                            Title="Don" />
            <PropertyColumn Property="x => x.Product.ProductQuality.Afla"
                            Title="Afla" />

            <PropertyColumn Property="x => x.DeliveryInfo.DeliveryParity"
                            Title="DeliveryParity" />
            <PropertyColumn Property="x => x.DeliveryInfo.LocationDetail"
                            Title="LocationDetail" />
            <PropertyColumn Property="x => x.DeliveryInfo.DeliveryDate"
                            Title="DeliveryDate" />

            <PropertyColumn Property="x => x.Price" Title="Price" />
            <PropertyColumn Property="x => x.Currency" Title="Currency" />

            <PropertyColumn Property="x => x.GMP" Title="GMP" />
            <PropertyColumn Property="x => x.ISCC" Title="ISCC" />

            <PropertyColumn Property="x => x.Records" Title="Records" />
            <PropertyColumn Property="x => x.PrivateNotes" Title="Private Notes" Editable="true" />
            
            

        </Columns>
        <PagerContent>
            <MudDataGridPager T="TradeEntry" />
        </PagerContent>
    
</MudDataGrid>
//for logging to see what grid does
    @if (_events.Any())
    {
        <MudExpansionPanels>
            <MudExpansionPanel Text="Events">
                @foreach (var ev in _events)
                {
                    <MudText Typo="Typo.body2">@ev</MudText>
                }
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
}

<p>Total Trades: @trades?.Count</p>



@code {
    private List<TradeEntry> trades = new();
    private MudDataGrid<TradeEntry>? gridRef;
    private string _search = "";
    private List<string> _events = new();

    protected override async Task OnInitializedAsync()
    {
        trades = await GoogleSheetService.GetAllTradesAsync();
        Console.WriteLine($"Loaded {trades.Count} trades from Google Sheets"); //logging
    }

    private bool QuickFilter(TradeEntry entry)
    {
        if (string.IsNullOrWhiteSpace(_search))
            return true;

        var s = _search.ToLower();

        return
            entry.Company?.CompanyName?.ToLower().Contains(s) == true ||
            entry.Company?.ContactPerson?.ToLower().Contains(s) == true ||
            entry.Product?.ProductName?.ToLower().Contains(s) == true ||
            entry.DeliveryInfo.DeliveryParity.ToString().ToLower().Contains(s) == true ||
            entry.DeliveryInfo.LocationDetail.ToString().ToLower().Contains(s) == true ||
            entry.DeliveryInfo.DeliveryDate?.ToLower().Contains(s) == true ||
            entry.TradeDirection.ToString().ToLower().Contains(s) ||
            entry.CatalogNumber.ToString().Contains(s);
    }


    private void ShareViaWhatsApp(TradeEntry entry)
    {
        
    }

    private async Task TestGoogleSheetRead()
    {
        trades = await GoogleSheetService.GetAllTradesAsync();

        Console.WriteLine($"TestRead: Found {trades?.Count ?? 0} trades");
        await InvokeAsync(StateHasChanged);
    }
}
}


