@page "/trades"
@using TradingApp.BlazorUI.Services
@inject ITradeService TradeService
@inject CsvTradeImporter Importer
@inject IWebHostEnvironment Env
@inject GoogleSheetTradeSyncService GoogleSheetService



<h3>Imported Trades</h3>

@if (trades == null)
{
    <p>Loading...</p>
}
else if (!trades.Any())
{
    <p>No trades found.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Catalog #</th>
                <th>Date</th>
                <th>Direction</th>

                <th>Product Name</th>
                <th>Quantity</th>

                <th>Protein (%)</th>
                <th>Test Weight</th>
                <th>Falling #</th>
                <th>Glassiness</th>
                <th>Oil Content</th>
                <th>Damaged Kernels</th>
                <th>DON</th>
                <th>AFLA</th>

                <th>Company</th>
                <th>Contact</th>

                <th>Delivery Parity</th>
                <th>Location</th>

                <th>Price</th>
                <th>Currency</th>

                <th>GMP</th>
                <th>ISCC</th>

                <th>Records</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var trade in trades.Where(t => t != null))
            {
                <tr>
                    <td>@trade.CatalogNumber</td>
                    <td>@trade.Date.ToShortDateString()</td>
                    <td>@trade.TradeDirection</td>

                    <td>@trade.Company?.CompanyName</td>
                    <td>@trade.Company?.ContactPerson</td>

                    <td>@trade.Product?.ProductName</td>                    
                    <td>@trade.Product?.Quantity</td>

                    <td>@trade.Product?.ProductQuality.Protein</td>
                    <td>@trade.Product?.ProductQuality.TestWeight</td>
                    <td>@trade.Product?.ProductQuality.FallingNumber</td>
                    <td>@trade.Product?.ProductQuality.Glassiness</td>
                    <td>@trade.Product?.ProductQuality.OilContent</td>
                    <td>@trade.Product?.ProductQuality.DamagedKernels</td>
                    <td>@trade.Product?.ProductQuality.Don</td>
                    <td>@trade.Product?.ProductQuality.Afla</td>

                    <td>@trade.DeliveryInfo?.DeliveryParity</td>
                    <td>@trade.DeliveryInfo?.LocationDetail</td>

                    <td>@trade.Price</td>
                    <td>@trade.Currency</td>

                    <td>@trade.GMP</td>
                    <td>@trade.ISCC</td>

                    <td>@trade.Records</td>
                    <td>@trade.PrivateNotes</td>
                </tr>
            }
        </tbody>
    </table>
}

<button @onclick="AppendTestTrade">Add Test Trade</button>

@code {
    
    //private List<TradeEntry> trades;

    //protected override async Task OnInitializedAsync() //Runs when the page is loaded — this is where data is fetched
    //{
     //   var csvPath = Path.Combine(Env.WebRootPath, "TradeData.csv");
     //   await Importer.ImportTradesFromCsv(csvPath);
     //   trades = await TradeService.GetAllTradesAsync(); //Calls EF-based data service to load data from the database.
    //}

    //Add a List<TradeEntry> to display trades
    private List<TradeEntry> trades = new();
    //Load data from Google Sheets on page load
    protected override async Task OnInitializedAsync()
    {
        trades = await GoogleSheetService.ReadTradesAsync();
    }

    private async Task AppendTestTrade()
    {
        var testTrade = new TradeEntry
        {
            CatalogNumber = 999,
            Date = DateTime.Now,
            TradeDirection = TradeDirectionType.Offer,
            Product = new Product
            {
                ProductName = "Test Product",
                Quantity = 100,
                ProductQuality = new ProductQuality
                {
                    Protein = 13.5f,
                    TestWeight = 78,
                    FallingNumber = 300,
                    Glassiness = 0,
                    OilContent = 0,
                    DamagedKernels = 0,
                    Don = 0,
                    Afla = 0
                }
            },
            Company = new Company
            {
                CompanyName = "Test Co",
                ContactPerson = "Test Person"
            },
            DeliveryInfo = new DeliveryInfo
            {
                DeliveryParity = ParityType.FCA,
                LocationDetail = "Test Location"
            },
            Price = 250,
            Currency = "EUR",
            GMP = GMP.NonGMP,
            ISCC = ISCC.NonISCC,
            Records = "Test record",
            PrivateNotes = "Some notes"
        };

        await GoogleSheetService.AppendTradeAsync(testTrade);

        // Optionally reload data
        trades = await GoogleSheetService.ReadTradesAsync();
    }
}

