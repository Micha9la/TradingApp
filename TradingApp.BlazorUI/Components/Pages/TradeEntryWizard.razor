@page "/trade-wizard/{direction}"

@inject NavigationManager Navigation
@using TradingApp.BlazorUI.Services
@using MudBlazor
@using System.Globalization;
@inject IDialogService DialogService //usfull if dialog is reused elsewhere.
@inject ITradeService GSTradeService

<h3>Create Trade - @TradeDirectionLabel</h3>

@if (IsFinished)
{
    <div class="alert alert-success">
        ✅ Trade saved successfully!
    </div>
    <div class="mt-3">
        <MudButton Variant="Variant.Filled" Color="Color.Secondary" Style="background-color: red; color: black;" Size="Size.Medium" @onclick="ShowSendDialog">
            Send to Clients
        </MudButton>
        <NavLink class="btn btn-primary" href="/trades">Go to Trades</NavLink>        
         <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Style="background-color: forestgreen; color: black;"
                   Size="Size.Medium"
                   OnClick="StartNewTrade">
            Add Another Trade
        </MudButton>         
    </div>
}
else
{
    <div class="wizard-step">
        @if (CurrentStep == 0)
        {
            <label>Company Name</label>
            <InputText class="form-control" 
                       @bind-Value="CurrentTrade.Company.CompanyName" 
                       list="companyList" />

            <datalist id="companyList">
                @foreach (var company in SortedCompanies)
                {
                    <option value="@company"></option>
                }
            </datalist>

        }
        else if (CurrentStep == 1)
        {
            <label>Contact Person</label>
            <InputText class="form-control" 
                        @bind-Value="CurrentTrade.Company.ContactPerson" 
                        list="contactList" />

            <datalist id="contactList">
                @foreach (var person in SortedContactPerson)
                {
                    <option value="@person"></option>
                }
            </datalist>
        }
        else if (CurrentStep == 2)
        {
            <label>Product Name</label>
            <InputText class="form-control" 
                        @bind-Value="CurrentTrade.Product.ProductName" 
                        list="productList" />

            <datalist id="productList">
                @foreach (var product in SortedProductName)
                {
                    <option value="@product"></option>
                }
            </datalist>
        }
        else if (CurrentStep == 3)
        {
            <label>Quantity (tons)</label>
            <MudAutocomplete T="int?"
                     @ref="activeInput"
                     @bind-Value="CurrentTrade.Product.Quantity"
                     Dense="true"
                     Clearable="true"
                     OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                     CoerceText="false"
                     ResetValueOnEmptyText="false"
                     SearchFunc="SearchQuantities"
                     ToStringFunc="@(q => q.HasValue ? q.Value.ToString() : string.Empty)"
                     TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Product.Quantity)))"
                     Style="width: 100%; max-width: 600px;" />
        }

        else if (CurrentStep == 4)
        {
            <label>Protein (%)</label>
            <MudAutocomplete T="float?"
                     @ref="activeInput"
                     @bind-Value="CurrentTrade.Product.ProductQuality.Protein"
                     Dense="true"
                     Clearable="true"
                     OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                     CoerceText="false"
                     ResetValueOnEmptyText="false"
                     SearchFunc="SearchProtein"
                     ToStringFunc="@(p => p.HasValue ? p.Value.ToString("0.##", CultureInfo.InvariantCulture) : string.Empty)"
                     TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Product.ProductQuality.Protein)))"
                     Style="width: 100%; max-width: 600px;" />
        }
        else if (CurrentStep == 5)
        {
            <label>Test Weight</label>
            <MudAutocomplete T="int?"
                   @ref="activeInput"
                     @bind-Value="CurrentTrade.Product.ProductQuality.TestWeight"
                     Dense="true"
                     Clearable="true"
                     OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                     CoerceText="false"
                     ResetValueOnEmptyText="false"
                     SearchFunc="SearchTestWeight"
                     ToStringFunc="@(t => t.HasValue ? t.Value.ToString() : string.Empty)"
                     TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Product.ProductQuality.TestWeight)))"
                     Style="width: 100%; max-width: 600px;" />
        }
        else if (CurrentStep == 6)
{
    <label>Falling Number</label>
    <MudAutocomplete T="int?"
                     @ref="activeInput"
                     @bind-Value="CurrentTrade.Product.ProductQuality.FallingNumber"
                     Dense="true"
                     Clearable="true"
                     OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                     CoerceText="false"
                     ResetValueOnEmptyText="false"
                     SearchFunc="SearchFallingNumber"
                     ToStringFunc="@(f => f.HasValue ? f.Value.ToString() : string.Empty)"
                     TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Product.ProductQuality.FallingNumber)))"
                     Style="width: 100%; max-width: 600px;" />
}

        else if (CurrentStep == 7)
{
    <label>Glassiness</label>
    <MudAutocomplete T="int?"
                    @ref="activeInput"
                     @bind-Value="CurrentTrade.Product.ProductQuality.Glassiness"
                     Dense="true"
                     Clearable="true"
                     OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                     CoerceText="false"
                     ResetValueOnEmptyText="false"
                     SearchFunc="SearchGlassiness"
                     ToStringFunc="@(g => g.HasValue ? g.Value.ToString() : string.Empty)"
                     TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Product.ProductQuality.Glassiness)))"
                     Style="width: 100%; max-width: 600px;" />
}
else if (CurrentStep == 8)
{
    <label>Oil Content</label>
    <MudAutocomplete T="int?"
        @ref="activeInput"
                     @bind-Value="CurrentTrade.Product.ProductQuality.OilContent"
                     Dense="true"
                     Clearable="true"
                     OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                     CoerceText="false"
                     ResetValueOnEmptyText="false"
                     SearchFunc="SearchOilContent"
                     ToStringFunc="@(o => o.HasValue ? o.Value.ToString() : string.Empty)"
                     TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Product.ProductQuality.OilContent)))"
                     Style="width: 100%; max-width: 600px;" />
}
        
        else if (CurrentStep == 9)
{
    <label>Damaged Kernels</label>
    <MudAutocomplete T="int?"
        @ref="activeInput"
                     @bind-Value="CurrentTrade.Product.ProductQuality.DamagedKernels"
                     Dense="true"
                     Clearable="true"
                     OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                     CoerceText="false"
                     ResetValueOnEmptyText="false"
                     SearchFunc="SearchDamagedKernels"
                     ToStringFunc="@(d => d.HasValue ? d.Value.ToString() : string.Empty)"
                     TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Product.ProductQuality.DamagedKernels)))"
                     Style="width: 100%; max-width: 600px;" />
}
        else if (CurrentStep == 10)
{
    <label>DON</label>
    <MudAutocomplete T="int?"
        @ref="activeInput"
                     @bind-Value="CurrentTrade.Product.ProductQuality.Don"
                     Dense="true"
                     Clearable="true"
                     OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                     CoerceText="false"
                     ResetValueOnEmptyText="false"
                     SearchFunc="SearchDon"
                     ToStringFunc="@(d => d.HasValue ? d.Value.ToString() : string.Empty)"
                     TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Product.ProductQuality.Don)))"
                     Style="width: 100%; max-width: 600px;" />
}
        else if (CurrentStep == 11)
{
    <label>Aflatoxin</label>
    <MudAutocomplete T="int?"
        @ref="activeInput"
                     @bind-Value="CurrentTrade.Product.ProductQuality.Afla"
                     Dense="true"
                     Clearable="true"
                     OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                     CoerceText="false"
                     ResetValueOnEmptyText="false"
                     SearchFunc="SearchAflatoxin"
                     ToStringFunc="@(a => a.HasValue ? a.Value.ToString() : string.Empty)"
                     TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Product.ProductQuality.Afla)))"
                     Style="width: 100%; max-width: 600px;" />
}
        else if (CurrentStep == 12)
        {
            <label>Delivery Parity</label>
            <InputSelect @bind-Value="CurrentTrade.DeliveryInfo.DeliveryParity">
                <option value="">-- Select Parity --</option>
                @foreach (var parity in Enum.GetValues<ParityType>())
                {
                    <option value="@parity">@parity</option>
                }
            </InputSelect>
        }
        else if (CurrentStep == 13)
        {
            <label>Location Detail</label>
            <InputText @bind-Value="CurrentTrade.DeliveryInfo.LocationDetail"
                       placeholder="Type or select location..."
                       @oninput="e => FilterSuggestions(e, nameof(CurrentTrade.DeliveryInfo.LocationDetail))" />

            @if (FilteredSuggestions?.Any() == true && ActiveField == nameof(CurrentTrade.DeliveryInfo.LocationDetail))
            {
                <ul class="suggestions">
                    @foreach (var suggestion in FilteredSuggestions)
                    {
                        <li @onclick="() => SelectSuggestion(suggestion, nameof(CurrentTrade.DeliveryInfo.LocationDetail))">@suggestion</li>
                    }
                </ul>
            }
        }
        
        else if (CurrentStep == 14)
{
    <label>Delivery Date</label>
    <InputText @bind-Value="CurrentTrade.DeliveryInfo.DeliveryDate"
               placeholder="Type delivery period (e.g., 1-3/2026)"
               @oninput="e => FilterSuggestions(e, nameof(CurrentTrade.DeliveryInfo.DeliveryDate))" />

    @if (FilteredSuggestions?.Any() == true && ActiveField == nameof(CurrentTrade.DeliveryInfo.DeliveryDate))
    {
        <ul class="suggestions">
            @foreach (var suggestion in FilteredSuggestions)
            {
                <li @onclick="() => SelectSuggestion(suggestion, nameof(CurrentTrade.DeliveryInfo.DeliveryDate))">
                    @suggestion
                </li>
            }
        </ul>
    }
}

else if (CurrentStep == 15)

{
    <label>Price</label>
    <MudAutocomplete T="decimal?"
        @ref="activeInput"
                 @bind-Value="CurrentTrade.Price"
                 Dense="true"
                 Clearable="true"
                 OpenPopupIcon="@Icons.Material.Filled.ArrowDropDown"
                 CoerceText="false"
                 ResetValueOnEmptyText="false"
                 SearchFunc="SearchPrice"                 
                 ToStringFunc="@(p => p.HasValue ? p.Value.ToString("0") : string.Empty)"
                 TextChanged="@(text => OnNumericFieldTextChanged(text, nameof(CurrentTrade.Price)))"
                 Style="width: 100%; max-width: 600px;" />
}
        else if (CurrentStep == 16)
        {
            <label>Currency</label>
            <InputText @bind-Value="CurrentTrade.Currency"
                       placeholder="Type or select currency..."
                       @oninput="e => FilterSuggestions(e, nameof(CurrentTrade.Currency))" />

            @if (FilteredSuggestions?.Any() == true && ActiveField == nameof(CurrentTrade.Currency))
            {
                <ul class="suggestions">
                    @foreach (var suggestion in FilteredSuggestions)
                    {
                        <li @onclick="() => SelectSuggestion(suggestion, nameof(CurrentTrade.Currency))">@suggestion</li>
                    }
                </ul>
            }
        }
        else if (CurrentStep == 17)
        {
            <label>GMP</label>
            <InputSelect @bind-Value="CurrentTrade.GMP">
                <option value="">-- Select GMP --</option>
                @foreach (var g in Enum.GetValues<GMP>())
                {
                    <option value="@g">@g</option>
                }
            </InputSelect>
        }
        else if (CurrentStep == 18)
        {
            <label>ISCC</label>
            <InputSelect @bind-Value="CurrentTrade.ISCC">
                <option value="">-- Select ISCC --</option>
                @foreach (var i in Enum.GetValues<ISCC>())
                {
                    <option value="@i">@i</option>
                }
            </InputSelect>
        }
        else if (CurrentStep == 19)
        {
            <label>Records Public</label>
            <InputText class="form-control" @bind-Value="CurrentTrade.Records" />
        }
        else if (CurrentStep == 20)
        {
            <label>Private Notes</label>
            <InputTextArea class="form-control" @bind-Value="CurrentTrade.PrivateNotes" />
        }

   </div>
}

<div class="wizard-buttons">
    @if (!IsFinished)
    {
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Size="Size.Large"
                   Disabled="@(CurrentStep == 0)"
                   OnClick="PrevStepAsync">
            Back
        </MudButton>

        @if (CurrentStep < StepsCount - 1)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       OnClick="NextStepAsync">
                Next
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       OnClick="FinishWizard">
                Finish
            </MudButton>
        }
    }    
</div>




@code {    
    //[Parameter] public TradeDirectionType direction { get; set; }
    [Parameter] public string direction { get; set; } = string.Empty;

    private string TradeDirectionLabel => CurrentTrade.TradeDirection.ToString();
    //158.barley 65kg, 300t, FCA Senica, 155€/t, 11-12/2025
    private async Task ShowSendDialog()
    {
        var message = $"Hello {CurrentTrade.Company?.ContactPerson ?? "! "}\n" +          
              $" {CurrentTrade.Records}\n\n" +
              "Regards,";

    var parameters = new DialogParameters
    {
        { "PrefilledMessage", message }
    };

    var options = new DialogOptions
    {
        CloseButton = true,
        MaxWidth = MaxWidth.Medium,
        FullWidth = true
    };

    var dialog = DialogService.Show<SendDialog>("Send Message", parameters, options);
    var result = await dialog.Result;
    
    }


    protected override async Task OnParametersSetAsync()
{
    // Keep existing initialization work if you have any - set the trade direction early.
    // Map the int 'direction' to your enum safely.
    if (Enum.TryParse<TradeDirectionType>(direction, true, out var parsed))
    {
        //CurrentTrade.TradeDirection = (TradeDirectionType)direction;
        CurrentTrade.TradeDirection = parsed;
    }
    else
    {
        // fallback to Offer if the param is out of range
        CurrentTrade.TradeDirection = TradeDirectionType.Offer;
    }

    await base.OnParametersSetAsync();
}
private dynamic? activeInput;

    private int CurrentStep { get; set; }
    private bool IsFinished { get; set; }

    private TradeEntry CurrentTrade { get; set; } = new TradeEntry 
    { 
        Company = new Company(), 
        Product = new Product { ProductQuality = new ProductQuality() }, 
        DeliveryInfo = new DeliveryInfo() 
    };

    private int StepsCount => 21; // adjust if adding/removing steps

    // Dynamic suggestions
    private List<string> FilteredSuggestions = new();
    private string ActiveField = "";

    // Frequency-sorted lists
    private List<string> SortedCompanies = new();
    private List<string> SortedContactPerson = new();
    private List<string> SortedProductName = new();

    private List<string> SortedQuantities = new();
    private List<string> SortedProtein = new();
    private List<string> SortedTestWeight = new();
    private List<string> SortedFallingNumber = new();
    private List<string> SortedGlassiness = new();
    private List<string> SortedOilContent = new();
    private List<string> SortedDamagedKernels = new();
    private List<string> SortedDon = new();
    private List<string> SortedAflatoxin = new();
    private List<string> SortedPrice = new();

    private List<string> SortedLocationDetail = new();
    public List<string> DeliveryDateSuggestions = new();
    private List<string> SortedCurrencies = new();
   
    

    private Task<IEnumerable<string>> SearchSuggestionsAsync(IEnumerable<string> source, string searchText)
    {
        if (string.IsNullOrWhiteSpace(searchText))
            return Task.FromResult(source);

        return Task.FromResult(
        source.Where(s => s.Contains(searchText, StringComparison.OrdinalIgnoreCase))
              .AsEnumerable()
    );
    }

    private Task<IEnumerable<int?>> SearchIntListNullable(List<string> source, string value)
{
    var list = source
        .Where(s => s.Contains(value ?? "", StringComparison.OrdinalIgnoreCase))
        .Select(s => int.TryParse(s, out var x) ? (int?)x : null)
        .Where(x => x.HasValue) // remove any failed parses
        .ToList();

    return Task.FromResult<IEnumerable<int?>>(list);
}


    private Task<IEnumerable<int?>> SearchQuantities(string value, CancellationToken token)
    => SearchIntListNullable(SortedQuantities, value);

    private Task<IEnumerable<float?>> SearchProtein(string value, CancellationToken token)
{
    var list = SortedProtein
        .Where(s => s.Contains(value ?? "", StringComparison.OrdinalIgnoreCase))
        .Select(s => float.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out var f)
            ? (float?)f
            : null)
        .Where(f => f.HasValue)
        .ToList();

    return Task.FromResult<IEnumerable<float?>>(list);
}

private Task<IEnumerable<int?>> SearchTestWeight(string value, CancellationToken token)
    => SearchIntListNullable(SortedTestWeight, value);
private Task<IEnumerable<int?>> SearchFallingNumber(string value, CancellationToken token)
    => SearchIntListNullable(SortedFallingNumber, value);

private Task<IEnumerable<int?>> SearchGlassiness(string value, CancellationToken token)
    => SearchIntListNullable(SortedGlassiness, value);

private Task<IEnumerable<int?>> SearchOilContent(string value, CancellationToken token)
    => SearchIntListNullable(SortedOilContent, value);

private Task<IEnumerable<int?>> SearchDamagedKernels(string value, CancellationToken token)
    => SearchIntListNullable(SortedDamagedKernels, value);

private Task<IEnumerable<int?>> SearchDon(string value, CancellationToken token)
    => SearchIntListNullable(SortedDon, value);

private Task<IEnumerable<int?>> SearchAflatoxin(string value, CancellationToken token)
    => SearchIntListNullable(SortedAflatoxin, value);
private Task<IEnumerable<decimal?>> SearchPrice(string value, CancellationToken token)
{
    var list = SortedPrice
        .Where(s => s.Contains(value ?? "", StringComparison.OrdinalIgnoreCase))
        .Select(s => decimal.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out var x) ? (decimal?)x : null)
        .Where(x => x.HasValue)
        .ToList();
    return Task.FromResult<IEnumerable<decimal?>>(list);
}

private void OnNumericFieldTextChanged(string text, string fieldName)
{
    if (string.IsNullOrWhiteSpace(text))
    {
        SetNumericValue(fieldName, null);
        return;
    }

    // Try to parse as int or float/decimal depending on the field
    if (decimal.TryParse(text, NumberStyles.Any, CultureInfo.InvariantCulture, out var decimalValue))
    {
        // Decide which type based on the property
        SetNumericValue(fieldName, decimalValue);
    }
}
private void SetNumericValue(string fieldName, decimal? value)
{
    switch (fieldName)
    {
        case nameof(CurrentTrade.Product.Quantity):
            CurrentTrade.Product.Quantity = value.HasValue ? (int?)value.Value : null;
            break;

        case nameof(CurrentTrade.Product.ProductQuality.Protein):
            CurrentTrade.Product.ProductQuality.Protein = value.HasValue ? (float?)value.Value : 0;
            break;

        case nameof(CurrentTrade.Product.ProductQuality.TestWeight):
            CurrentTrade.Product.ProductQuality.TestWeight = value.HasValue ? (int?)value.Value : null;
            break;

        case nameof(CurrentTrade.Product.ProductQuality.FallingNumber):
            CurrentTrade.Product.ProductQuality.FallingNumber = value.HasValue ? (int?)value.Value : null;
            break;

        case nameof(CurrentTrade.Product.ProductQuality.Glassiness):
            CurrentTrade.Product.ProductQuality.Glassiness = value.HasValue ? (int?)value.Value : null;
            break;

        case nameof(CurrentTrade.Product.ProductQuality.OilContent):
            CurrentTrade.Product.ProductQuality.OilContent = value.HasValue ? (int?)value.Value : null;
            break;

        case nameof(CurrentTrade.Product.ProductQuality.DamagedKernels):
            CurrentTrade.Product.ProductQuality.DamagedKernels = value.HasValue ? (int?)value.Value : null;
            break;

        case nameof(CurrentTrade.Product.ProductQuality.Don):
            CurrentTrade.Product.ProductQuality.Don = value.HasValue ? (int?)value.Value : null;
            break;

        case nameof(CurrentTrade.Product.ProductQuality.Afla):
            CurrentTrade.Product.ProductQuality.Afla = value.HasValue ? (int?)value.Value : null;
            break;

        case nameof(CurrentTrade.Price):
            CurrentTrade.Price = value;
            break;
    }
}

    //Information can be entered through the UI or via Excel, it ends up in SortedX because both come from trades.
    protected override async Task OnInitializedAsync() 
    {
        var trades = await GSTradeService.GetAllTradesAsync();

        SortedCompanies = trades 
        .Where(t => !string.IsNullOrWhiteSpace(t.Company?.CompanyName)) 
        .GroupBy(t => t.Company.CompanyName.Trim()) 
        .OrderByDescending(g => g.Count()) 
        .Select(g => g.Key) 
        .ToList(); 
        
        SortedContactPerson = trades 
        .Where(t => !string.IsNullOrWhiteSpace(t.Company?.ContactPerson)) 
        .GroupBy(t => t.Company.ContactPerson.Trim()) 
        .OrderByDescending(g => g.Count()) 
        .Select(g => g.Key) .ToList()
        .ToList();
        
        SortedProductName = trades 
        .Where(t => !string.IsNullOrWhiteSpace(t.Product?.ProductName)) 
        .GroupBy(t => t.Product.ProductName.Trim()) 
        .OrderByDescending(g => g.Count()) 
        .Select(g => g.Key) 
        .ToList(); 
        
        SortedQuantities = trades
        .Where(t => t.Product?.Quantity > 0)
        .GroupBy(t => t.Product.Quantity)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key.ToString())         
        .ToList();

        SortedProtein = trades
        .Where(t => t.Product?.ProductQuality?.Protein > 0)
        .GroupBy(t => t.Product.ProductQuality.Protein)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key?.ToString(CultureInfo.InvariantCulture) ?? string.Empty) // InvariantCulture: different locales (e.g., commas vs. dots as decimal separators
        .ToList();

        SortedTestWeight = trades
        .Where(t => t.Product?.ProductQuality.TestWeight > 0)   
        .GroupBy(t => t.Product.ProductQuality.TestWeight)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key.ToString())     
        .ToList();

        SortedFallingNumber = trades
        .Where(t => t.Product?.ProductQuality.FallingNumber > 0)   
        .GroupBy(t => t.Product.ProductQuality.FallingNumber)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key.ToString())    
        .ToList();

        SortedGlassiness = trades
        .Where(t => t.Product?.ProductQuality.Glassiness > 0)  
        .GroupBy(t => t.Product.ProductQuality.Glassiness)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key.ToString())    
        .ToList();

        SortedOilContent = trades
        .Where(t => t.Product?.ProductQuality.OilContent > 0)   
        .GroupBy(t => t.Product.ProductQuality.OilContent)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key.ToString())      
        .ToList();

        SortedDamagedKernels = trades
        .Where(t => t.Product?.ProductQuality.DamagedKernels > 0)   
        .GroupBy(t => t.Product.ProductQuality.DamagedKernels)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key.ToString())       
        .ToList();

        SortedDon = trades
        .Where(t => t.Product?.ProductQuality.Don > 0)   
        .GroupBy(t => t.Product.ProductQuality.Don)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key.ToString())   
        .ToList();

        SortedAflatoxin = trades
        .Where(t => t.Product?.ProductQuality.Afla > 0)   
        .GroupBy(t => t.Product.ProductQuality.Afla)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key.ToString())    
        .ToList();

        SortedPrice = trades
    .Where(t => t.Price.HasValue && t.Price.Value > 0)   // filter non-null positive prices
    .GroupBy(t => t.Price.Value)                         // group by decimal value
    .OrderByDescending(g => g.Count())
    .Select(g => g.Key.ToString("0", CultureInfo.InvariantCulture)) // format as integer string
    .ToList();


        SortedLocationDetail = trades 
        .Where(t => !string.IsNullOrWhiteSpace(t.DeliveryInfo?.LocationDetail)) 
        .GroupBy(t => t.DeliveryInfo.LocationDetail.Trim()) 
        .OrderByDescending(g => g.Count()) 
        .Select(g => g.Key) 
        .ToList(); 
        
        DeliveryDateSuggestions = trades
    .Where(t => !string.IsNullOrWhiteSpace(t.DeliveryInfo?.DeliveryDate))
    .GroupBy(t => t.DeliveryInfo.DeliveryDate.Trim())
    .OrderByDescending(g => g.Count())
    .Select(g => g.Key)
    .ToList();

        SortedCurrencies = trades 
        .Where(t => !string.IsNullOrWhiteSpace(t.Currency)) 
        .GroupBy(t => t.Currency.Trim()) 
        .OrderByDescending(g => g.Count()) 
        .Select(g => g.Key) 
        .ToList(); 
    }

    private void FilterSuggestions(ChangeEventArgs e, string field)
    {
        var value = e.Value?.ToString() ?? "";
        ActiveField = field;

        var source = field switch
        {
            nameof(CurrentTrade.Company.CompanyName) => SortedCompanies,
            nameof(CurrentTrade.Company.ContactPerson) => SortedContactPerson,
            nameof(CurrentTrade.Product.ProductName) => SortedProductName,
            nameof(CurrentTrade.Product.Quantity) => SortedQuantities,
            nameof(CurrentTrade.DeliveryInfo.LocationDetail) => SortedLocationDetail,
            nameof(CurrentTrade.DeliveryInfo.DeliveryDate) => DeliveryDateSuggestions,
            nameof(CurrentTrade.Currency) => SortedCurrencies,
            _ => new List<string>()
        };

        FilteredSuggestions = source
            .Where(s => s.Contains(value, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private void SelectSuggestion(string suggestion, string field)
    {
        switch (field)
        {
            case nameof(CurrentTrade.Company.CompanyName):
                CurrentTrade.Company.CompanyName = suggestion;
                break;
            case nameof(CurrentTrade.Company.ContactPerson):
                CurrentTrade.Company.ContactPerson = suggestion;
                break;
            case nameof(CurrentTrade.Product.ProductName):
                CurrentTrade.Product.ProductName = suggestion;
                break;
            case nameof(CurrentTrade.Product.Quantity):
                if (int.TryParse(suggestion, out var qty))
                {
                    CurrentTrade.Product.Quantity = qty;
                }
                break; //user will see past quantities as suggestions while typing.
            case nameof(CurrentTrade.DeliveryInfo.LocationDetail):
                CurrentTrade.DeliveryInfo.LocationDetail = suggestion;
                break;
            case nameof(CurrentTrade.DeliveryInfo.DeliveryDate):
                CurrentTrade.DeliveryInfo.DeliveryDate = suggestion;
                break;
            case nameof(CurrentTrade.Currency):
                CurrentTrade.Currency = suggestion;
                break;
        }

        FilteredSuggestions.Clear();
        ActiveField = "";
    }


private string BuildTradeSummary()
{
    // Direction label from enum
    var dirLabel = CurrentTrade.TradeDirection == TradeDirectionType.Offer
        ? "Indicative offer"
        : "Indicative bid";

    // Catalog number (you use int, so just ToString)
    var catalog = CurrentTrade.CatalogNumber.ToString();

    // Product name (null-safe)
    var productName = CurrentTrade.Product?.ProductName ?? "n/a";

    // Quantity - handle nullable or non-nullable quantity safely
    string qty;
    if (CurrentTrade.Product?.Quantity is int q) // works if Quantity is int or int?
        qty = $"{q}t";
    else
        qty = "n/a";

    // Delivery parity (DeliveryInfo may be null; DeliveryParity is enum, non-nullable)
    var parity = CurrentTrade.DeliveryInfo != null
        ? CurrentTrade.DeliveryInfo.DeliveryParity.ToString()
        : "";

    // Location detail
    var location = CurrentTrade.DeliveryInfo?.LocationDetail ?? "";

    // Price - handle decimal? safely
    string price;
    if (CurrentTrade.Price is decimal p)
        price = p.ToString("0", CultureInfo.InvariantCulture); // integer-like formatting
    else
        price = "n/a";

    // DeliveryDate is a free-form string in your model — keep it as-is
    var deliveryDate = CurrentTrade.DeliveryInfo?.DeliveryDate ?? "n/a";

    // Build and return the one-line summary
    return $"{dirLabel}: {catalog}.{productName}, {qty}, {parity} {location}, {price}€/t, {deliveryDate}";
}


    private async Task FocusCurrentInputAsync()
{
    try
    {
        await activeInput?.FocusAsync();
    }
    catch { }
}

    private async Task NextStepAsync()
{
    await Task.Yield();

    // If we are about to enter Step 19 (i.e., coming from Step 18)
    if (CurrentStep == 18)
    {
        // Assign next catalog number now so the summary shows the correct value
        CurrentTrade.CatalogNumber = await GSTradeService.GetNextCatalogNumberAsync();

        // Prefill editable summary only if empty
        if (string.IsNullOrWhiteSpace(CurrentTrade.Records))
        {
            CurrentTrade.Records = BuildTradeSummary();
        }
    }

    if (CurrentStep < StepsCount - 1)
    {
        CurrentStep++;
        await Task.Delay(50);
        await FocusCurrentInputAsync();
    }
    else
    {
        await FinishWizard();
    }
}




private async Task PrevStepAsync()
{
    if (CurrentStep > 0)
    {
        CurrentStep--;
        await Task.Delay(50);
        await FocusCurrentInputAsync();
    }
}

    private async Task FinishWizard()
{
    // If Records somehow empty at final save, fill with generated summary
    if (string.IsNullOrWhiteSpace(CurrentTrade.Records))
    {
        CurrentTrade.Records = BuildTradeSummary();
    }

    // unique, sequential CatalogNumber from the sheet itself
    CurrentTrade.CatalogNumber = await GSTradeService.GetNextCatalogNumberAsync();
    CurrentTrade.Date = DateTime.UtcNow; // assign save date

    Console.WriteLine($"Saving trade — Catalog: {CurrentTrade.CatalogNumber}, Direction: {CurrentTrade.TradeDirection}");

    // Save to Google Sheets
    await GSTradeService.AppendTradeAsync(CurrentTrade);

    IsFinished = true; //show success screen
}


    private async Task FinishWizard2()
    {        
        //unique, sequential CatalogNumber from the sheet itself
        CurrentTrade.CatalogNumber = await GSTradeService.GetNextCatalogNumberAsync();
        CurrentTrade.Date = DateTime.UtcNow; // assign save date

        Console.WriteLine($"Saving trade — Catalog: {CurrentTrade.CatalogNumber}, Direction: {CurrentTrade.TradeDirection}");

        // Save to Google Sheets
        await GSTradeService.AppendTradeAsync(CurrentTrade);

        //Console.WriteLine("Saving trade: " + System.Text.Json.JsonSerializer.Serialize(CurrentTrade));

        IsFinished = true; //show success screen
    }
    
    private void StartNewTrade()
{
    Navigation.NavigateTo("/landingpage");
}
}




